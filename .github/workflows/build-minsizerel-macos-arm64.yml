name: Build OpenUSD MinSizeRel (macOS ARM64)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14  # M1/M2 runner

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        brew install cmake ninja

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Verify uv installation
      run: |
        source $HOME/.cargo/env
        uv --version

    - name: Clone OpenUSD repository
      run: |
        chmod +x ./01-checkout-macos.sh
        ./01-checkout-macos.sh

    - name: Build TBB
      run: |
        chmod +x ./02-download-tbb-macos.sh
        ./02-download-tbb-macos.sh

    - name: Configure MinSizeRel build
      run: |
        source $HOME/.cargo/env
        chmod +x ./03-configure-minsizerel-macos.sh
        ./03-configure-minsizerel-macos.sh

    - name: Build and install MinSizeRel
      run: |
        chmod +x ./04-build-minsizerel-macos.sh
        ./04-build-minsizerel-macos.sh

    - name: Generate environment setup script
      run: |
        chmod +x ./05-setup-env-minsizerel-macos.sh
        ./05-setup-env-minsizerel-macos.sh

    - name: Verify installation
      run: |
        source dist-minsizerel-ms/setup-usd-env.sh
        usdcat --help
        .venv/bin/python -c "from pxr import Usd; print('USD Version:', Usd.GetVersion())"

    - name: Show library size
      run: |
        ls -lh dist-minsizerel-ms/lib/lteusd_ms.dylib
        echo "Library size: $(du -h dist-minsizerel-ms/lib/lteusd_ms.dylib | cut -f1)"

    - name: Package artifact
      run: |
        cd dist-minsizerel-ms
        tar -czf ../openusd-minsizerel-macos-arm64.tar.gz \
          --exclude='*.pyc' \
          --exclude='__pycache__' \
          .
        cd ..
        ls -lh openusd-minsizerel-macos-arm64.tar.gz

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: openusd-minsizerel-macos-arm64
        path: openusd-minsizerel-macos-arm64.tar.gz
        retention-days: 30
        compression-level: 0  # Already compressed

    - name: Upload installation directory
      uses: actions/upload-artifact@v4
      with:
        name: openusd-minsizerel-installation-macos-arm64
        path: |
          dist-minsizerel-ms/
          !dist-minsizerel-ms/**/*.pyc
          !dist-minsizerel-ms/**/__pycache__
        retention-days: 7
