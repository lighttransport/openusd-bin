name: Build OpenUSD MinSizeRel

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          python3-dev \
          curl

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Verify uv installation
      run: |
        uv --version

    - name: Clone OpenUSD repository
      run: |
        chmod +x ./01-checkout.sh
        ./01-checkout.sh

    - name: Build TBB
      run: |
        chmod +x ./02-download-tbb.sh
        ./02-download-tbb.sh

    - name: Configure MinSizeRel build
      run: |
        chmod +x ./03-configure-minsizerel.sh
        ./03-configure-minsizerel.sh

    - name: Build and install MinSizeRel
      run: |
        chmod +x ./04-build-minsizerel.sh
        ./04-build-minsizerel.sh

    - name: Generate environment setup script
      run: |
        chmod +x ./05-setup-env-minsizerel.sh
        ./05-setup-env-minsizerel.sh

    - name: Verify installation
      run: |
        source dist-minsizerel-ms/setup-usd-env.sh
        usdcat --help
        .venv/bin/python -c "from pxr import Usd; print('USD Version:', Usd.GetVersion())"

    - name: Show library size
      run: |
        ls -lh dist-minsizerel-ms/lib/lteusd_ms.so
        echo "Library size: $(du -h dist-minsizerel-ms/lib/lteusd_ms.so | cut -f1)"

    - name: Package artifact
      run: |
        cd dist-minsizerel-ms
        tar -czf ../openusd-minsizerel-linux-x86_64.tar.gz \
          --exclude='*.pyc' \
          --exclude='__pycache__' \
          .
        cd ..
        ls -lh openusd-minsizerel-linux-x86_64.tar.gz

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: openusd-minsizerel-linux-x86_64
        path: openusd-minsizerel-linux-x86_64.tar.gz
        retention-days: 30
        compression-level: 0  # Already compressed

    - name: Upload installation directory
      uses: actions/upload-artifact@v4
      with:
        name: openusd-minsizerel-installation
        path: |
          dist-minsizerel-ms/
          !dist-minsizerel-ms/**/*.pyc
          !dist-minsizerel-ms/**/__pycache__
        retention-days: 7
