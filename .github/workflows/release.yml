name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0, v0.25.11, etc.
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a new release'
        required: false
        type: boolean
        default: false
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: false
        type: string

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '24'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          ninja-build \
          libgl1-mesa-dev \
          libglu1-mesa-dev \
          python3-dev \
          curl

    - name: Install uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Clone OpenUSD repository
      run: ./01-checkout.sh

    - name: Build TBB
      run: ./02-download-tbb.sh

    - name: Configure MinSizeRel build
      run: ./03-configure-minsizerel.sh

    - name: Build and install MinSizeRel
      run: ./04-build-minsizerel.sh

    - name: Generate environment setup script
      run: ./05-setup-env-minsizerel.sh

    - name: Verify installation
      run: |
        source dist-minsizerel-ms/setup-usd-env.sh
        usdcat --help
        .venv/bin/python -c "from pxr import Usd; print('USD Version:', Usd.GetVersion())"

    - name: Get OpenUSD version
      id: usd_version
      run: |
        source dist-minsizerel-ms/setup-usd-env.sh
        USD_VERSION=$(.venv/bin/python -c "from pxr import Usd; v=Usd.GetVersion(); print(f'{v[0]}.{v[1]}.{v[2]}')")
        echo "version=${USD_VERSION}" >> $GITHUB_OUTPUT
        echo "USD Version: ${USD_VERSION}"

    - name: Create build info
      run: |
        cat > dist-minsizerel-ms/BUILD_INFO.txt << EOF
        OpenUSD Build Information
        ========================

        Build Type: MinSizeRel (Size-Optimized Monolithic)
        USD Version: ${{ steps.usd_version.outputs.version }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Git Commit: ${GITHUB_SHA::8}

        Configuration:
        - Namespace: pxr_lte
        - Library Prefix: lte
        - Monolithic: ON
        - Python Support: ON
        - Imaging: OFF

        Platform:
        - OS: Ubuntu $(lsb_release -rs)
        - Compiler: $(gcc --version | head -n1)
        - CMake: $(cmake --version | head -n1)

        Library Size:
        $(ls -lh dist-minsizerel-ms/lib/lteusd_ms.so | awk '{print "- Monolithic Library: " $5}')

        Usage:
        ------
        1. Extract the archive
        2. Source the environment setup:
           source setup-usd-env.sh
        3. Verify installation:
           usdcat --help
           python -c "from pxr import Usd; print(Usd.GetVersion())"

        Note: This build includes TBB libraries which are included in the distribution.
        EOF

    - name: Copy TBB to package
      run: |
        if [ -d dist/tbb ]; then
          echo "Copying TBB to package..."
          cp -r dist/tbb dist-minsizerel-ms/tbb
          echo "TBB copied successfully"
        else
          echo "Warning: TBB directory not found at dist/tbb"
        fi

    - name: Package artifact
      run: |
        cd dist-minsizerel-ms
        tar -czf ../openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64.tar.gz \
          --exclude='*.pyc' \
          --exclude='__pycache__' \
          .
        cd ..

    - name: Calculate checksums
      run: |
        sha256sum openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64.tar.gz > checksums.txt
        cat checksums.txt

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64
        path: |
          openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64.tar.gz
          checksums.txt
        retention-days: 90

    - name: Create Release
      if: github.event_name == 'push' || github.event_name == 'release' || inputs.create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ inputs.release_tag || github.ref_name }}
        draft: false
        prerelease: false
        files: |
          openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64.tar.gz
          checksums.txt
        body: |
          ## OpenUSD MinSizeRel Build

          **USD Version:** ${{ steps.usd_version.outputs.version }}
          **Build Type:** MinSizeRel (Size-Optimized Monolithic)
          **Platform:** Linux x86_64

          ### Features
          - Custom namespace: `pxr_lte`
          - Library prefix: `lte`
          - Monolithic library (~45 MB)
          - Python bindings included
          - Minimal size optimization (94.6% smaller than RelWithDebInfo)

          ### Installation
          ```bash
          # Extract
          tar -xzf openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64.tar.gz

          # Setup environment
          cd openusd-${{ steps.usd_version.outputs.version }}-minsizerel-linux-x86_64
          source setup-usd-env.sh

          # Verify
          usdcat --help
          ```

          ### Checksums
          See `checksums.txt` for SHA256 checksums.
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
